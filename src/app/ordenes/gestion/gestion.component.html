<app-solcitud 
[solicitud]="solicitud"
[orden]="orden"
(onCloseModal)="solicitud = false">
</app-solcitud>

<app-devolucion
        [devolucion]="devolucion"
        (onCloseModal)="devolucion = false">
</app-devolucion>
<app-despacho
[despacho]="despacho"
(onCloseModal)="despacho = false"
>

</app-despacho>

<div class="container">
    <div class="card">
        <div class="card-content">
            <div class="titulo">
                Gestiones
                <br>
            <ng-container *ngIf="!usuario.Despacho">
                <button class="button is-primary" (click)='modal_nueva_gestion()' *ngIf="usuario.Almacen != 2 || usuario.Role == 'ADMIN'">Nueva Gestión</button> 
            </ng-container>    
                <!-- <button class="button is-primary" (click)='nuevo_despacho()'>Despacho</button> -->
            </div>
            <ng-container *ngIf="!usuario.Despacho">
            <div class="select" *ngIf="usuario.Almacen != 2 || usuario.Role == 'ADMIN'">
                    <select (change)='fase($event)'>
                        <option>Seleccionar fase</option>
                        <option value="{{funcion}}" *ngFor='let funcion of FUNCIONES'>{{funcion}}</option>
                    </select>
                </div>
            </ng-container>
            <ng-container *ngIf="!usuario.Despacho">
             <button class="button is-success" (click)="TraerTareasFueraDeFecha()" *ngIf="usuario.Almacen != 2 ||usuario.Role == 'ADMIN'">Otras Gestiones</button>
            </ng-container>
             <button class="button is-primary" (click)='modal_Devolucion()' *ngIf="usuario.Despacho != 1">Devolución de materiales</button>
             <button class="button is-primary" (click)='modal_solicitud()' *ngIf="usuario.Despacho != 1">Solicitud de materiales</button>
            
            <hr>
            <div class="despachos" *ngIf="usuario.Almacen == 2 || usuario.Despacho == 1">
                <div class="subtitulo">
                    Despachos pendientes:
                </div>

                <table class="table is-fullwidth" *ngFor="let despacho of Despachos;index as x">
                    <thead>
                        <tr>
                            <th>Fecha: {{despacho.fecha}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                           <td>
                            <table class="table is-fullwidth is-bordered ">
                                <thead>
                                    <tr>
                                        <th>OP</th>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>OC</th>
                                        <th>Destino</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let productos of despacho.despacho;index as y">
                                        <td>{{productos.op}}</td>
                                        <td>{{productos.producto}}</td>
                                        <td>
                                            <ng-container *ngIf="edit === x">
                                                <input type="Number" class="input" value="{{productos.cantidad}}" (change)="editado($event.target.value, x,y)">
                                            </ng-container>
                                            <ng-container *ngIf="edit != x">
                                                {{productos.cantidad}}
                                            </ng-container>
                                        </td>
                                        <td>{{productos.oc}}</td>
                                        <td>{{productos.destino}}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="button is-success" (click)="editar_cant(x)" *ngIf="edit != x">
                                <span class="icon is-small">
                                    <i class="fas fa-edit"></i>
                                </span>
                                <span>Editar cantidades</span>
                            </button> 
                              <button class="button is-success" (click)="listo()" *ngIf="edit === x">
                                <span class="icon is-small">
                                    <i class="fas fa-check"></i>
                                </span>
                                <span>Listo</span>
                              </button> 
                              <button class="button is-success" *ngIf="edit != x" (click)="Despachado_(despacho._id, x)">
                                <span class="icon is-small">
                                    <i class="fas fa-check"></i>
                                </span>
                                <span>Despachado</span>
                              </button>
                           </td> 
                        </tr>
                    </tbody>
                </table>
            </div>

            <ng-container *ngIf="!usuario.Despacho">
            <div class="subtitulo" *ngIf="usuario.Almacen != 2 || usuario.Role == 'ADMIN'">
                Ordenes para el dia de Hoy: <br>
            </div>
            </ng-container>
            <ng-container *ngIf="!usuario.Despacho">
                <table class="table is-fullwidth" *ngIf="usuario.Almacen != 2 || usuario.Role == 'ADMIN'">
                    <thead>
                        <tr>
                            <th>Orden</th>
                            <th>Producto</th>
                            <th>Máquina</th>
                            <th>Cant. Hojas</th>
                            <th>Cant. Productos</th>
                            <th>Fecha Estimada</th>
                            <th>Finalizar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor='let trabajo of TRABAJOS'>
                        <ng-container *ngIf="trabajo.orden.estado === 'activo'">
                            <td>{{trabajo.orden.sort}}</td>
                            <td>{{trabajo.orden.producto.producto}}</td>
                            <td>{{trabajo.maquina.nombre}}</td>
                            <td>{{redondear(trabajo.orden.cantidad, trabajo.orden.producto.ejemplares[trabajo.orden.montaje])}}</td>
                            <td>{{trabajo.orden.cantidad}}</td>
                            <td>{{trabajo.fecha}}</td>
                            <button class="button is-success" (click)='finalizar_gestion(trabajo._id)' *ngIf="usuario.Role == 'ADMIN' && !jo">Finalizar</button>
                            <td>
                                
                                <ng-container *ngFor='let gestion of GESTIONES;let i = index'>
                                    <ng-container *ngIf='gestion.orden === trabajo._id'>
                                        <button class="button is-success" (click)='finalizar_gestion(trabajo._id)' *ngIf="gestion.Rproductos <= 0">Finalizar</button>
                                        {{JustOne(gestion.Rproductos)}}
                                        
                                        <!-- <ng-container *ngIf="gestion.Rproductos < 0">
                                            <button class="button is-success" disabled >finalizar</button>
                                        </ng-container> -->
                                    </ng-container>
                                </ng-container>
                            
                            
                            </td>
                        </ng-container>
                        </tr>
                    </tbody>
                </table>
            </ng-container>
            <hr>
            <ng-container *ngIf="!usuario.Despacho">
            <div class="subtitulo" *ngIf="usuario.Almacen != 2 || usuario.Role == 'ADMIN'">
                Gestiones Realizadas: <br>
            </div>
            <div *ngFor='let trabajo of TRABAJOS'>
            <ng-container *ngIf="trabajo.orden.estado === 'activo'">
                ORDEN: <b>{{trabajo.orden.sort}}</b> - {{trabajo.orden.producto.producto}}
                <table class="table is-fullwidth">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Máquina</th>
                            <th>Cant. de Hojas</th>
                            <th>Cant. de Productos</th>
                            <th>Restante</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor='let gestion of GESTIONES;let i = index'>
                            <tr *ngIf='gestion.orden === trabajo._id'>
                                <td>{{gestion.fecha}}</td>
                                <td>{{gestion.maquina.nombre}}</td>
                                <td>{{gestion.hojas}}</td>
                                <td>{{gestion.productos}}</td>
                                <td>{{gestion.Rhojas}} (Hojas) / {{gestion.Rproductos}} (Productos)</td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
                <hr>
                <ng-container *ngFor='let gestion of GESTIONES;let i = index'>
                    <ng-container *ngIf='gestion.orden === trabajo._id'>
                        <button class="button is-success" (click)='acelerar(trabajo.orden._id, trabajo.maquina, trabajo.fecha,trabajo._id, trabajo.fechaI,1)' *ngIf="gestion.Rproductos <= 0">Adelantar Entrega</button>
                    </ng-container>
                </ng-container>
                <button class="button is-danger" (click)='retrasar(trabajo.orden._id, trabajo.maquina, trabajo.fecha,trabajo._id, 1)'>Retrasar entrega</button>
                <hr>
            </ng-container>
            </div>
        </ng-container>
        </div>
    </div>
</div>


<div class="modal" [ngClass]="{'is-active':NUEVA_GESTION}">
    <div class="modal-background" (click)='modal_nueva_gestion()'></div>
    <div class="modal-card">
        <div class="modal-card-body">
            <div class="subtitulo">
                Gestion
            </div>
            <hr>
            <div class="columns">
                <div class="column">
                    <b>Orden:</b><br>
                    <div class="select">
                        <select id='orden_selected'>
                                <option value="#">Seleccionar Orden</option>
                            <ng-container *ngFor='let trabajo of TRABAJOS'>
                                <option value="{{trabajo.orden._id}}-{{trabajo._id}}-{{trabajo.maquina.tipo}}-{{trabajo.orden.producto.grupo}}" *ngIf="trabajo.orden.estado=== 'activo'">{{trabajo.orden.sort}}</option>
                            </ng-container>
                        </select>
                    </div>
                </div>
                <div class="column">
                    <b>Gestion Realizada en Hojas:</b><br>
                    <input type="number" class="input" id='hojas_input' (change)='calcular_Productos($event)'>
                    <br>
                    <b>Gestion Realizada en Productos</b>
                    <input type="number" class="input" id='productos_input' (change)='calcular_Hojas($event)'>
                </div>
            </div>
            <hr>
            <button class="button is-primary" (click)='finalizar()'>Finalizar</button>
        </div>
    </div>
</div>